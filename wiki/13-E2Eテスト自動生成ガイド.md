# E2E テスト自動生成ガイド（GitHub Copilot カスタムコマンド）

## 概要

このドキュメントは、GitHub Copilot の **カスタムコマンド** を使用して、Playwright E2E テストを効率的に生成するためのガイドです。

カスタムコマンド「`e2e-test-generator`」を使用することで、プロジェクトの規約に従った高品質な E2E テストを迅速に作成できます。

---

## 📍 ファイル配置

```
.github/
└── prompts/
    └── e2e-test-generator.prompt.md  ← このコマンド
```

---

## 🎯 カスタムコマンドの目的

このカスタムコマンドは、以下を実現します：

✅ **プロジェクト規約の統一**
- Vue 3 + Vuetify フレームワークに最適化
- アクセシビリティベースのセレクタ使用を強制
- テスト命名規則の統一

✅ **開発効率の向上**
- テンプレート化されたテストコード生成
- ベストプラクティスに従ったコード出力
- 手動でのプロンプト記述を削減

✅ **テスト品質の維持**
- ポジティブ・ネガティブテストの両方
- 適切な待機処理の組み込み
- エラーハンドリングの最小限化

---

## 🚀 使い方

### Step 1. GitHub Copilot Chat を開く

VS Code で以下のいずれかの方法で Copilot Chat を開きます：

- **キーボード**: `Ctrl + Shift + I`（Windows/Linux）/ `Cmd + Shift + I`（Mac）
- **メニュー**: VS Code のメニュー → Copilot

### Step 2. コマンドを実行

Chat ウィンドウで `/` キーを入力すると、利用可能なコマンドのリストが表示されます。

```
/e2e-test-generator
```

または、直接フルネームを入力：

```
/e2e-test-generator
```

### Step 3. テスト作成依頼を追加

コマンド実行後、テスト作成の詳細な指示を入力します：

```
ログイン機能のE2Eテストを作成してください。
以下の3パターンのテストケースを含めてください：
1. 正しい認証情報でログイン成功
2. 空のユーザ名でエラー表示
3. 不正なパスワードでエラー表示
```

### Step 4. コードを確認・実行

生成されたテストコードを確認：

```bash
cd frontend

# テストの実行
npm test:e2e

# レポートの確認
npm test:e2e:report
```

---

## 📋 コマンド内容の詳細

### YAML フロントマター

```yaml
---
name: e2e-test-generator
description: Playwrightを使用したE2Eテストを生成するプロンプト
tools: [read, edit, search, shell]
---
```

| 設定項目 | 説明 |
|---------|------|
| `name` | コマンド名（Chat で `/e2e-test-generator` で呼び出し） |
| `description` | コマンドの説明 |
| `tools` | 使用可能なツール（ファイル読み書き、検索、シェル実行） |

---

## 🎓 プロンプトの構成

コマンドには以下の重要な情報が含まれています：

### 1️⃣ プロジェクト情報

```markdown
## プロジェクト情報

### アプリケーション仕様
- フレームワーク: Vue 3 + Vuetify 3
- テストフレームワーク: Playwright
- 基本URL: http://localhost:5173
- 主なページ: LOGIN、TOP、TODO、MEMO
```

**作用**: Copilot が、このプロジェクト特有のフレームワークとページ構成を理解

### 2️⃣ テスト設定

```markdown
### テスト設定
- テスト配置: frontend/tests/e2e/
- タイムアウト: 30秒（テスト）, 5秒（assertion）
- ブラウザ: Chrome（Chromium）
- リポート: Allure + HTML
```

**作用**: Copilot が正しい設定値でテストを生成

### 3️⃣ 必須要件

```markdown
### テストコードの構造
1. ファイル配置: frontend/tests/e2e/ に *.spec.ts で配置
2. 命名規則: 機能別にスネークケース + .spec.ts
3. インポート: import { test, expect } from '@playwright/test';
```

**作用**: ファイル配置と命名を統一

### 4️⃣ ユーザーセレクタの優先順位

```markdown
優先度1: aria-label, role（アクセシビリティ）
優先度2: getByPlaceholder（入力フィールド）
優先度3: getByText（ボタン・テキスト）
優先度4: getByRole（汎用）
優先度5: CSS selector（最後の手段）
```

**作用**: 脆弱性のないセレクタ使用を強制

### 5️⃣ テストケース設計パターン

```typescript
// ポジティブテスト（正常系）テンプレート
test('機能名が正常に動作すること', async ({ page }) => {
  await page.goto('/path');
  await page.getByLabel('ラベル').fill('値');
  await page.getByRole('button', { name: /ボタン名/ }).click();
  await page.waitForURL(/\/expected-path/);
  await expect(page.getByText('成功メッセージ')).toBeVisible();
});

// ネガティブテスト（異常系）テンプレート
test('不正な入力時に警告が表示されること', async ({ page }) => {
  await page.goto('/path');
  await page.getByLabel('メールアドレス').fill('invalid-email');
  await page.getByRole('button', { name: /送信/ }).click();
  await expect(page.getByText(/有効なメールアドレス/)).toBeVisible();
});
```

**作用**: 一貫性のあるテスト構造で生成

### 6️⃣ ベストプラクティス

```markdown
### 命名規則
✅ 良い例: 'ユーザーが有効なTODOを作成できること'
❌ 悪い例: 'test 1'

### セレクタの使い方
✅ 推奨: await page.getByLabel('ユーザ名').fill('user');
❌ 避ける: await page.locator('.login-form input[type="text"]').fill('user');

### 検証（Assertions）
✅ 複数検証で信頼性向上
❌ 単一検証のみ
```

**作用**: コード品質を強制

### 7️⃣ チェックリスト

生成されたテストが確認すべき項目：

```markdown
- [ ] ファイル名が *.spec.ts の形式か
- [ ] import { test, expect } が記述されているか
- [ ] 各テストが独立して実行可能か
- [ ] セレクタがアクセシビリティベースか
- [ ] 適切な待機処理があるか
- [ ] テスト名が日本語で意図が明確か
- [ ] ポジティブ・ネガティブテストが両方か
- [ ] ローカルで実行確認したか
```

---

## 💡 使用例

### 例 1: ログイン機能テスト

**リクエスト:**

```
/e2e-test-generator

ログイン機能のE2Eテストを作成してください。
以下の3パターンのテストケースを含めてください：
1. 正しい認証情報でログイン成功
2. 空のユーザ名でエラー表示
3. 不正なパスワードでエラー表示
```

**生成される出力:**

```typescript
// frontend/tests/e2e/login.spec.ts
import { test, expect } from '@playwright/test';

test.describe('ログイン機能のテスト', () => {
  test('正しい認証情報でログイン成功すること', async ({ page }) => {
    await page.goto('/login');
    await page.getByLabel('ユーザ名').fill('testuser');
    await page.getByLabel('パスワード').fill('Test1234!');
    await page.getByRole('button', { name: /ログイン/ }).click();
    await page.waitForURL(/\/top/);
    await expect(page.getByText('TOP 画面')).toBeVisible();
  });

  test('空のユーザ名でエラーが表示されること', async ({ page }) => {
    await page.goto('/login');
    await page.getByLabel('パスワード').fill('Test1234!');
    await page.getByRole('button', { name: /ログイン/ }).click();
    await expect(page.getByText(/ユーザ名が必須です/)).toBeVisible();
  });

  test('不正なパスワードでエラーが表示されること', async ({ page }) => {
    await page.goto('/login');
    await page.getByLabel('ユーザ名').fill('testuser');
    await page.getByLabel('パスワード').fill('wrongpassword');
    await page.getByRole('button', { name: /ログイン/ }).click();
    await expect(page.getByText(/パスワードが正しくありません/)).toBeVisible();
  });
});
```

### 例 2: TODO 管理機能テスト

**リクエスト:**

```
/e2e-test-generator

TODO管理機能のテストを作成してください。
以下のテストケースを含めてください：
1. TODOアイテムを追加できること
2. 空のテキストでエラーが表示されること
3. TODOアイテムを削除できること
```

**生成される出力:**

```typescript
// frontend/tests/e2e/todo.spec.ts
import { test, expect } from '@playwright/test';

test.describe('TODO管理機能のテスト', () => {
  test('TODOアイテムを追加できること', async ({ page }) => {
    await page.goto('/top');
    await page.getByRole('link', { name: /TODO/ }).click();
    await page.getByPlaceholder('TODOを入力').fill('新しいタスク');
    await page.getByRole('button', { name: /追加/ }).click();
    await expect(page.getByText('新しいタスク')).toBeVisible();
  });

  test('空のテキストでエラーが表示されること', async ({ page }) => {
    await page.goto('/todo');
    await page.getByRole('button', { name: /追加/ }).click();
    await expect(page.getByText(/TODOの内容を入力してください/)).toBeVisible();
  });

  test('TODOアイテムを削除できること', async ({ page }) => {
    await page.goto('/todo');
    const todoItem = page.getByText('テスト用TODO');
    await todoItem.getByRole('button', { name: /削除/ }).click();
    await expect(todoItem).not.toBeVisible();
  });
});
```

### 例 3: メモ機能テスト

**リクエスト:**

```
/e2e-test-generator

メモ機能のテストを作成してください。
CRUD操作（作成、読込、更新、削除）をテストしてください。
```

**結果:**
- `frontend/tests/e2e/memo.spec.ts` が自動生成
- 4つのテストケース（CRUD）を含む
- すぐに実行可能な状態

---

## 🔧 生成されたテストの実行方法

### すべてのテストを実行

```bash
cd frontend
npm test:e2e
```

**出力例:**
```
✓ tests/e2e/login.spec.ts (3 tests passed)
✓ tests/e2e/todo.spec.ts (3 tests passed)
✓ tests/e2e/memo.spec.ts (4 tests passed)

Total: 10 tests passed in 45.2s
```

### 特定のテストファイルのみ実行

```bash
cd frontend
npm test:e2e -- login.spec.ts
```

### デバッグモードで実行（ブラウザを表示）

```bash
cd frontend
npx playwright test --headed
```

### UI モードで実行（ステップバイステップ）

```bash
cd frontend
npx playwright test --ui
```

### Allure レポート確認

```bash
cd frontend
npm test:e2e:report
```

ブラウザで詳細なレポートが表示されます：
- テスト成功率
- テスト実行時間
- スクリーンショット（失敗時）
- ビデオ（失敗時）

---

## ✅ テスト作成時のチェックリスト

コマンドを使ってテストを生成した後、必ず以下を確認してください：

| 項目 | チェック |
|------|---------|
| ファイル名が `*.spec.ts` 形式 | ☐ |
| インポートが正しい | ☐ |
| 各テストが独立して実行可能 | ☐ |
| セレクタがアクセシビリティベース | ☐ |
| 待機処理が適切 | ☐ |
| テスト名が日本語で意図が明確 | ☐ |
| ポジティブ・ネガティブテストが両方 | ☐ |
| ローカルで実行確認 | ☐ |

---

## 🐛 トラブルシューティング

### Q1. テスト実行時に「要素が見つからない」エラー

**原因**: セレクタが変わっている、またはアプリケーションの UI が変更

**解決策:**
```bash
# Playwright Code Generator で最新のセレクタを確認
npx playwright codegen http://localhost:5173

# テストを修正
npm test:e2e -- --headed
```

### Q2. テストが不安定（たまに失敗）

**原因**: 待機処理が不足している

**解決策:**
```typescript
// ❌ 悪い例
await page.getByText('テキスト').click();

// ✅ 良い例
await page.getByText('テキスト').waitFor();
await page.getByText('テキスト').click();
```

### Q3. GitHub Copilot Chat でコマンドが見つからない

**確認事項:**
1. `.github/prompts/e2e-test-generator.prompt.md` が存在するか
2. `name:` フィールドが正しいか
3. VS Code を再起動してみる
4. GitHub Copilot を再度有効化

### Q4. 生成されたテストが実行できない

**確認事項:**
```bash
# 1. Playwright が正しくインストールされているか
npx playwright --version

# 2. ブラウザがインストールされているか
npx playwright install

# 3. アプリケーションが起動しているか
curl http://localhost:5173
```

---

## 📊 よくある問題と解決策

| 問題 | 原因 | 解決策 |
|------|------|--------|
| **タイムアウトエラー** | 要素が見つからない、ページ読み込み遅延 | `waitFor()` / `waitForURL()` を追加 |
| **セレクタエラー** | UI が変更された | `npx playwright codegen` で確認 |
| **テスト順序の依存** | 状態の引き継ぎ | 各テストで初期化処理を追加 |
| **不安定なテスト** | タイミングの問題 | 待機処理を追加 |
| **スクリーンショット不足** | ビューポートサイズ | 画面全体をスクロール確認 |

---

## 📚 関連ドキュメント

- [GitHub Copilot カスタムコマンド vs カスタムエージェント比較](./12-カスタムコマンドVSカスタムエージェント比較.md)
- [テスト戦略](./08-テスト戦略.md)
- [README - E2E テスト実行](../README.md#-e2e-テスト実行)

---

## 🎯 まとめ

| 観点 | 説明 |
|------|------|
| **実行コマンド** | `/e2e-test-generator` |
| **生成ファイル** | `frontend/tests/e2e/[feature].spec.ts` |
| **実行方法** | `npm test:e2e` |
| **レポート確認** | `npm test:e2e:report` |
| **デバッグ方法** | `npx playwright test --headed` |

このカスタムコマンドを使用することで、プロジェクト規約に従い、効率的で品質の高い E2E テストを素早く生成できます。

---

**作成日**: 2026年1月  
**最終更新**: 2026年1月
