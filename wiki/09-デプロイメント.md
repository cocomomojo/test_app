# ğŸš¢ 9. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€Test App ã®ãƒ“ãƒ«ãƒ‰æ–¹æ³•ã¨æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ­ã‚»ã‚¹ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

---

## ğŸ› ï¸ ãƒ“ãƒ«ãƒ‰æ‰‹é †

### Backendï¼ˆSpring Bootï¼‰ã®ãƒ“ãƒ«ãƒ‰

#### JAR ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ“ãƒ«ãƒ‰

```bash
cd backend

# Gradle ã‚’ä½¿ç”¨ã—ã¦ãƒ“ãƒ«ãƒ‰
./gradlew clean build

# ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
# build/libs/test-app-*.jar
```

#### ãƒ“ãƒ«ãƒ‰æ™‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³

```bash
# ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãƒ“ãƒ«ãƒ‰
./gradlew build -x test

# ç‰¹å®šã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ“ãƒ«ãƒ‰
./gradlew build -Dspring.profiles.active=production

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ“ãƒ«ãƒ‰
./gradlew clean build --refresh-dependencies
```

#### ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèª

```bash
# JAR ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºç¢ºèª
ls -lh build/libs/

# JAR ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ç¢ºèª
jar tf build/libs/test-app-*.jar | head -20
```

### Frontendï¼ˆVue.js + Viteï¼‰ã®ãƒ“ãƒ«ãƒ‰

#### Production ãƒ“ãƒ«ãƒ‰

```bash
cd frontend

# ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# æœ¬ç•ªç”¨ã«ãƒ“ãƒ«ãƒ‰
npm run build

# ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
# dist/
#   â”œâ”€â”€ index.html
#   â”œâ”€â”€ assets/
#   â”‚   â”œâ”€â”€ index-xxxxxx.js
#   â”‚   â”œâ”€â”€ index-xxxxxx.css
#   â””â”€â”€ ...
```

#### ãƒ“ãƒ«ãƒ‰æœ€é©åŒ–

```bash
# æœ¬ç•ªãƒ“ãƒ«ãƒ‰ã®è©³ç´°åˆ†æ
npm run build -- --analyze

# ãƒ“ãƒ«ãƒ‰ã‚µã‚¤ã‚ºã®ç¢ºèª
du -sh dist/
```

---

## ğŸ³ Docker ã§ã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤

### Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã®æ§‹ç¯‰

#### Backend ã‚¤ãƒ¡ãƒ¼ã‚¸

```bash
cd backend

# Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
docker build -t test-app:backend-latest .

# ã¾ãŸã¯ã€docker-compose ã‚’ä½¿ç”¨
cd ../infra
docker compose build backend
```

**Dockerfile ã®ç¢ºèªï¼š**
```dockerfile
FROM eclipse-temurin:21-jdk-alpine
WORKDIR /app
COPY build/libs/test-app-*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java","-jar","app.jar"]
```

#### Frontend ã‚¤ãƒ¡ãƒ¼ã‚¸

```bash
cd frontend

# Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆNginx ãƒ™ãƒ¼ã‚¹ï¼‰
docker build -t test-app:frontend-latest .

# ã¾ãŸã¯ã€docker-compose ã‚’ä½¿ç”¨
cd ../infra
docker compose build frontend
```

### Docker Compose ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤

#### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ

```bash
cd infra

# é–‹ç™ºç”¨ Compose ã§èµ·å‹•
docker compose -f docker-compose.local.yml up -d --build

# ãƒ­ã‚°ç¢ºèª
docker compose -f docker-compose.local.yml logs -f
```

#### CI ç’°å¢ƒ

```bash
cd infra

# CI ç”¨ Compose ã§èµ·å‹•
docker compose -f docker-compose.ci.yml up -d

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
docker compose -f docker-compose.ci.yml exec backend ./gradlew test
```

#### ã‚³ãƒ³ãƒ†ãƒŠã®ç®¡ç†

```bash
# ã‚³ãƒ³ãƒ†ãƒŠã®ç¢ºèª
docker ps
docker ps -a

# ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ç¢ºèª
docker logs <container-id>
docker logs -f <container-id>

# ã‚³ãƒ³ãƒ†ãƒŠã«æ¥ç¶š
docker exec -it <container-id> /bin/bash

# ã‚³ãƒ³ãƒ†ãƒŠã®åœæ­¢
docker stop <container-id>

# ã‚³ãƒ³ãƒ†ãƒŠã®å‰Šé™¤
docker rm <container-id>

# ã‚¤ãƒ¡ãƒ¼ã‚¸ã®å‰Šé™¤
docker rmi <image-id>
```

---

## ğŸ”„ GitHub Actions CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

### CI ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆè‡ªå‹•ãƒ†ã‚¹ãƒˆï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«ï¼š`.github/workflows/e2e.yml`**

```yaml
name: E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: test_app
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: ~/.gradle/caches
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Build Backend
      run: |
        cd backend
        ./gradlew clean build -Dspring.profiles.active=ci
    
    - name: Build Frontend
      run: |
        cd frontend
        npm install
        npm run build
    
    - name: Run E2E Tests
      run: |
        cd frontend
        npm run test:headless
    
    - name: Generate Allure Report
      if: always()
      run: |
        cd frontend
        npm run test:allure
    
    - name: Deploy Report to GitHub Pages
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./frontend/allure-results
```

### å®Ÿè¡Œçµæœã®ç¢ºèª

```bash
# GitHub Actions ã®å®Ÿè¡ŒçŠ¶æ…‹ã‚’ç¢ºèª
# ãƒªãƒã‚¸ãƒˆãƒªã® Actions ã‚¿ãƒ–ã‹ã‚‰ç¢ºèªã§ãã¾ã™
# https://github.com/cocomomojo/test_app/actions

# ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèª
# GitHub Pages ã§è‡ªå‹•å…¬é–‹ã•ã‚Œã¾ã™
# https://cocomomojo.github.io/test_app/
```

---

## ğŸ“Š ç’°å¢ƒåˆ¥è¨­å®š

### Backend è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

#### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºï¼ˆapplication-local.ymlï¼‰

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/test_app
    username: root
    password: test123
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true

server:
  port: 8080

logging:
  level:
    root: INFO
    com.example.project: DEBUG
```

#### CI ç’°å¢ƒï¼ˆapplication-ci.ymlï¼‰

```yaml
spring:
  datasource:
    url: jdbc:mysql://mysql:3306/test_app
    username: root
    password: root
  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: false

server:
  port: 8080

logging:
  level:
    root: WARN
    com.example.project: INFO
```

#### æœ¬ç•ªç’°å¢ƒï¼ˆapplication-prod.ymlï¼‰

```yaml
spring:
  datasource:
    url: jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_NAME}
    username: ${DB_USER}
    password: ${DB_PASSWORD}
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false

server:
  port: 8080
  ssl:
    enabled: true
    key-store: ${SSL_KEYSTORE_PATH}
    key-store-password: ${SSL_PASSWORD}

logging:
  level:
    root: WARN
    com.example.project: INFO
```

### Frontend è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

#### é–‹ç™ºç’°å¢ƒï¼ˆvite.config.jsï¼‰

```javascript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  plugins: [vue()],
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true,
      }
    }
  },
  build: {
    outDir: 'dist',
    sourcemap: true
  }
})
```

#### æœ¬ç•ªç’°å¢ƒï¼ˆnginx.confï¼‰

```nginx
server {
    listen 80;
    server_name _;
    
    root /usr/share/nginx/html;
    index index.html;
    
    # SPA ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å¯¾å¿œ
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API ãƒ—ãƒ­ã‚­ã‚·
    location /api {
        proxy_pass http://backend:8080/api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

---

## ğŸ“¦ æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

### æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆSSHï¼‰

```bash
# 1. ãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶š
ssh user@production-server.com

# 2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd /opt/test-app

# 3. æœ€æ–°ã‚³ãƒ¼ãƒ‰ã‚’ãƒ—ãƒ«
git pull origin main

# 4. Backend ã‚’ãƒ“ãƒ«ãƒ‰
cd backend
./gradlew clean build -Dspring.profiles.active=prod

# 5. Frontend ã‚’ãƒ“ãƒ«ãƒ‰
cd ../frontend
npm install
npm run build

# 6. Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
cd ../infra
docker compose build

# 7. ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•
docker compose up -d

# 8. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
curl http://localhost:8080/actuator/health
```

### è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆCI/CDï¼‰

```bash
# GitHub Actions ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã†
# .github/workflows/deploy.yml ã‚’è¨­å®š

# ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œä¾‹
git push origin main
# â†’ GitHub Actions ãŒè‡ªå‹•å®Ÿè¡Œ
# â†’ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
# â†’ ãƒ“ãƒ«ãƒ‰
# â†’ æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
```

---

## âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ç¢ºèªã™ã¹ãé …ç›®ï¼š

- [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¦ã„ã‚‹
- [ ] ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå®Œäº†ã—ã¦ã„ã‚‹
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæœ€æ–°åŒ–ã•ã‚Œã¦ã„ã‚‹
- [ ] ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¯èƒ½ã§ã‚ã‚‹
- [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ãŒæº–å‚™ã•ã‚Œã¦ã„ã‚‹
- [ ] æœ¬ç•ªç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¦ã„ã‚‹
- [ ] ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šãŒå®Œäº†ã—ã¦ã„ã‚‹
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãŒå®Œäº†ã—ã¦ã„ã‚‹

---

## ğŸš¨ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•å¤±æ•—

```bash
# ãƒ­ã‚°ã‚’ç¢ºèª
docker logs <container-id> | grep -i error

# ãƒãƒ¼ãƒˆç¢ºèª
lsof -i :8080  # Linux/Mac
netstat -ano | findstr :8080  # Windows
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼

```bash
# MySQL ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ç¢ºèª
docker ps
docker logs mysql-container

# MySQL ã«ç›´æ¥æ¥ç¶š
docker exec -it mysql-container mysql -u root -ptest123
```

### ãƒ¡ãƒ¢ãƒªä¸è¶³

```bash
# Docker ã‚³ãƒ³ãƒ†ãƒŠã®ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ã‚’ç¢ºèª
docker stats

# ãƒ¡ãƒ¢ãƒªã‚’å¢—ã‚„ã™
docker compose down
# docker-compose.yml ã®ãƒ¡ãƒ¢ãƒªè¨­å®šã‚’å¤‰æ›´
docker compose up -d
```

---

## ğŸ“š æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- [ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰](./10-ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰.md) - é–‹ç™ºãƒ«ãƒ¼ãƒ«
- [ã¾ã¨ã‚](./11-ã¾ã¨ã‚.md) - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·æ‹¬
