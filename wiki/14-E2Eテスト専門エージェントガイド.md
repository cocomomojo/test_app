# E2E テスト専門エージェント ガイド

## 概要

このドキュメントは、GitHub Copilot の **カスタムエージェント** を使用して、Playwright E2E テストを効率的に作成するためのガイドです。

カスタムエージェント「`e2e-test-specialist`」は、GitHub Issue に自動アサインできる専門エージェントで、プロジェクトの規約に従った高品質な E2E テストを自動で実装します。

---

## 📍 ファイル配置

```
.github/
├── agents/
│   └── e2e-test-specialist.agent.md  ← このエージェント
└── prompts/
    └── e2e-test-generator.prompt.md  ← カスタムコマンド（別機能）
```

---

## 🎯 カスタムエージェントとカスタムコマンドの違い

| 機能 | カスタムコマンド | **カスタムエージェント** |
|------|:---:|:---:|
| **実行方法** | 手動で `/コマンド` 実行 | **Issue に自動アサイン** |
| **並列実行** | 不可 | **可能（複数 Issue 同時）** |
| **自動化レベル** | 軽度 | **高度（自動実装）** |
| **用途** | 繰り返しタスク | **複雑なワークフロー** |
| **設定難易度** | 低 | **高（詳細な定義必要）** |

---

## 🚀 使い方

### 方法 1: GitHub Issue でエージェントを利用（推奨）

#### Step 1. GitHub Issue を作成

GitHub リポジトリで新しい Issue を作成します。

**Issue タイトル:**
```
ログイン機能のE2Eテスト作成
```

**Issue 本文（テンプレート）:**
```markdown
# ログイン機能のE2Eテスト作成

## 背景
ログイン機能の品質保証のため、E2Eテストを追加する必要があります。

## テストシナリオ
- [ ] 正常系: 正しい認証情報でログイン成功
- [ ] 異常系: 空のユーザ名でエラー表示
- [ ] 異常系: 空のパスワードでエラー表示
- [ ] 異常系: 不正な認証情報でエラー表示

## 受け入れ条件
- すべてのテストがローカルで成功すること
- Allureレポートが生成されること
- テストカバレッジが80%以上であること
- アクセシビリティベースのセレクタを使用していること

## 実装場所
- ファイル: `frontend/tests/e2e/login.spec.ts`
```

#### Step 2. エージェントをアサイン

1. Issue の右側から **「Assignees」** をクリック
2. **`@e2e-test-specialist`** を検索・選択
3. エージェントが自動的にテストコードの実装を開始

#### Step 3. Pull Request を確認

エージェントが以下を自動で実施：
- テストファイルの作成
- テストコードの実装
- Pull Request の作成

レビュー後、マージしてください。

---

### 方法 2: VS Code の GitHub Copilot Chat で直接利用

#### Step 1. Copilot Chat を開く

VS Code で以下のいずれかの方法で Copilot Chat を開きます：

- **キーボード**: `Ctrl + Shift + I`（Windows/Linux）/ `Cmd + Shift + I`（Mac）
- **メニュー**: VS Code のメニュー → Copilot

#### Step 2. エージェントを呼び出す

```
@e2e-test-specialist

ログイン機能のE2Eテストを作成してください。
以下のテストシナリオを含めてください：
- 正しい認証情報でログイン成功
- 空のユーザ名でエラー表示
- 不正なパスワードでエラー表示
```

#### Step 3. 生成されたコードを確認

エージェントがテストコードを生成します。内容を確認してファイルに保存してください。

---

## 📋 エージェントの構成要素

### 1️⃣ プロジェクト情報

エージェントには、このプロジェクト固有の情報が組み込まれています：

```markdown
### アプリケーション構成
- フレームワーク: Vue 3 + Vuetify 3
- ビルドツール: Vite 5.0+
- 主なページ: /login, /top, /todo, /memo

### テスト技術スタック
- テストフレームワーク: Playwright 1.40.0+
- レポート: Allure 2.13.9+
- 言語: TypeScript
- ブラウザ: Chrome（Chromium）
```

**作用**: エージェントが、プロジェクトの環境を正確に理解してコード生成

---

### 2️⃣ 実行可能なコマンド

エージェントが知っているコマンド一覧：

```bash
# テスト実行
cd frontend && npm test:e2e
cd frontend && npm test:e2e -- login.spec.ts
cd frontend && npx playwright test --headed

# レポート生成
cd frontend && npm run test:e2e:report

# デバッグ
cd frontend && npx playwright test --ui
cd frontend && npx playwright codegen http://localhost:5173
```

**作用**: テスト実行方法を理解し、適切なコマンドを提案

---

### 3️⃣ テストの書き方

エージェントに組み込まれたテンプレート：

```typescript
import { test, expect } from '@playwright/test';

// 共通フィクスチャ
const login = async (page) => {
  await page.goto('/login');
  await page.getByLabel('ユーザ名').fill('testuser');
  await page.getByLabel('パスワード').fill('Test1234!');
  await page.getByRole('button', { name: /ログイン/ }).click();
  await page.waitForURL(/\/top/);
};

// テストグループ
test.describe('[機能名] のテスト', () => {
  test('[正常系] 機能が正常に動作すること', async ({ page }) => {
    await login(page);
    // テスト処理
  });
  
  test('[異常系] エラーが適切に表示されること', async ({ page }) => {
    // テスト処理
  });
});
```

**作用**: 一貫性のある構造でテストを生成

---

### 4️⃣ セレクタの優先順位

エージェントが厳守する優先順位：

```typescript
// 優先度1: アクセシビリティベース（推奨）
await page.getByLabel('ユーザ名');
await page.getByRole('button', { name: /ログイン/ });

// 優先度2: テキストベース
await page.getByText('成功しました');

// 優先度3: Test ID
await page.getByTestId('submit-button');

// 優先度4: CSS selector（最終手段）
await page.locator('.btn-primary'); // ❌ 避ける
```

**作用**: 脆弱性のないセレクタを常に使用

---

### 5️⃣ Git ワークフロー

エージェントが従うルール：

```bash
# ブランチ命名規則
feature/e2e-login-test
fix/e2e-todo-timeout

# コミットメッセージ（Conventional Commits）
test: ログイン機能のE2Eテストを追加
fix: TODOテストのセレクタを修正
```

**作用**: Git の規約に従ったコミットを生成

---

### 6️⃣ 境界線（Boundaries）

エージェントの行動規則：

#### ✅ 常に行うこと（Always Do）
- テストの独立性を確保
- 適切な待機処理を実装
- アクセシビリティベースのセレクタを優先
- 複数の検証を含める
- ポジティブ・ネガティブテストを両方実装

#### ⚠️ 確認が必要なこと（Ask First）
- 新しいページ・機能のテスト追加
- 既存テストの大幅な変更
- テスト設定（playwright.config.ts）の変更

#### ❌ 絶対にやらないこと（Never Do）
- 失敗するテストをコメントアウト
- ソースコードを変更してテストを通そうとする
- 本番環境の設定を変更
- 認証情報をハードコード
- CSSセレクタを多用
- 固定時間待機（sleep）を多用

**作用**: エージェントが、安全で品質の高いコードのみを生成

---

## 💡 実例

### 例 1: ログイン機能テスト（GitHub Issue 経由）

#### Issue 作成

**タイトル:**
```
ログイン機能のE2Eテスト作成
```

**本文:**
```markdown
## 背景
ログイン機能の品質保証のため、E2Eテストを追加する必要があります。

## テストシナリオ
- [ ] 正常系: 正しい認証情報でログイン成功
- [ ] 異常系: 空のユーザ名でエラー表示
- [ ] 異常系: 不正なパスワードでエラー表示

## 受け入れ条件
- すべてのテストがローカルで成功すること
- Allureレポートが生成されること
```

#### エージェントのアサイン
- Assignees で `@e2e-test-specialist` を選択

#### 生成されるファイル
```typescript
// frontend/tests/e2e/login.spec.ts
import { test, expect } from '@playwright/test';

test.describe('ログイン機能のテスト', () => {
  test('正しい認証情報でログイン成功すること', async ({ page }) => {
    await page.goto('/login');
    await page.getByLabel('ユーザ名').fill('testuser');
    await page.getByLabel('パスワード').fill('Test1234!');
    await page.getByRole('button', { name: /ログイン/ }).click();
    await page.waitForURL(/\/top/);
    await expect(page.getByText('TOP 画面')).toBeVisible();
  });

  test('空のユーザ名でエラーが表示されること', async ({ page }) => {
    await page.goto('/login');
    await page.getByLabel('パスワード').fill('Test1234!');
    await page.getByRole('button', { name: /ログイン/ }).click();
    await expect(page.getByText(/ユーザ名が必須です/)).toBeVisible();
  });

  test('不正なパスワードでエラーが表示されること', async ({ page }) => {
    await page.goto('/login');
    await page.getByLabel('ユーザ名').fill('testuser');
    await page.getByLabel('パスワード').fill('wrongpassword');
    await page.getByRole('button', { name: /ログイン/ }).click();
    await expect(page.getByText(/パスワードが正しくありません/)).toBeVisible();
  });
});
```

#### Pull Request 作成
エージェントが自動で PR を作成し、レビュー待ち状態になります。

---

### 例 2: TODO 管理機能テスト（Copilot Chat 経由）

#### Chat での指示

```
@e2e-test-specialist

TODO管理機能のE2Eテストを作成してください。
以下のテストシナリオを含めてください：
1. TODOアイテムを追加できること
2. 空のテキストでエラーが表示されること
3. TODOアイテムを削除できること
4. TODOアイテムを完了マークできること
```

#### 生成されるコード

```typescript
// frontend/tests/e2e/todo.spec.ts
import { test, expect } from '@playwright/test';

const login = async (page) => {
  await page.goto('/login');
  await page.getByLabel('ユーザ名').fill('testuser');
  await page.getByLabel('パスワード').fill('Test1234!');
  await page.getByRole('button', { name: /ログイン/ }).click();
  await page.waitForURL(/\/top/);
};

test.describe('TODO管理機能のテスト', () => {
  test('TODOアイテムを追加できること', async ({ page }) => {
    await login(page);
    await page.goto('/todo');
    
    const title = `テストTODO-${Date.now()}`;
    await page.getByLabel('新しい TODO を入力').fill(title);
    await page.getByRole('button', { name: '追加' }).click();
    
    await expect(page.getByText(title)).toBeVisible();
  });

  test('空のテキストでエラーが表示されること', async ({ page }) => {
    await login(page);
    await page.goto('/todo');
    
    await page.getByRole('button', { name: '追加' }).click();
    await expect(page.getByText(/TODOの内容を入力してください/)).toBeVisible();
  });

  test('TODOアイテムを削除できること', async ({ page }) => {
    await login(page);
    await page.goto('/todo');
    
    // TODOを作成
    const title = `削除用TODO-${Date.now()}`;
    await page.getByLabel('新しい TODO を入力').fill(title);
    await page.getByRole('button', { name: '追加' }).click();
    await expect(page.getByText(title)).toBeVisible();
    
    // 削除
    const todoItem = page.getByText(title).locator('..');
    await todoItem.getByRole('button', { name: /削除/ }).click();
    await expect(page.getByText(title)).not.toBeVisible();
  });

  test('TODOアイテムを完了マークできること', async ({ page }) => {
    await login(page);
    await page.goto('/todo');
    
    // TODOを作成
    const title = `完了用TODO-${Date.now()}`;
    await page.getByLabel('新しい TODO を入力').fill(title);
    await page.getByRole('button', { name: '追加' }).click();
    
    // 完了マーク
    const todoItem = page.getByText(title).locator('..');
    await todoItem.getByRole('checkbox').check();
    
    // 完了状態を検証
    await expect(todoItem).toHaveClass(/completed/);
  });
});
```

---

## 🔧 生成されたテストの実行方法

### すべてのテストを実行

```bash
cd frontend
npm test:e2e
```

**出力例:**
```
✓ tests/e2e/login.spec.ts (3 tests passed)
✓ tests/e2e/todo.spec.ts (4 tests passed)

Total: 7 tests passed in 32.5s
```

### 特定のテストファイルのみ実行

```bash
cd frontend
npm test:e2e -- login.spec.ts
```

### Allure レポート確認

```bash
cd frontend
npm run test:e2e:report
```

ブラウザで詳細なレポートが表示されます。

---

## 📊 カスタムコマンド vs カスタムエージェント 使い分け

| シチュエーション | 推奨機能 | 理由 |
|---------------|---------|------|
| **簡単なテスト追加** | カスタムコマンド | 手軽、すぐに実行可能 |
| **複雑なテスト追加** | **カスタムエージェント** | 詳細な要件を Issue に記載できる |
| **複数テスト並列作成** | **カスタムエージェント** | 複数 Issue に同時アサイン可能 |
| **コード例が欲しい** | カスタムコマンド | Chat で対話的に修正可能 |
| **自動PR作成が必要** | **カスタムエージェント** | GitHub 連携が強い |

---

## 🐛 トラブルシューティング

### Q1. エージェントが Issue に表示されない

**確認事項:**
1. `.github/agents/e2e-test-specialist.agent.md` が存在するか
2. `name:` フィールドが `e2e-test-specialist` になっているか
3. GitHub リポジトリに push されているか
4. GitHub Copilot が有効になっているか

### Q2. エージェントが間違ったコードを生成する

**解決策:**
1. Issue の本文を詳細に記述する
   - 背景、テストシナリオ、受け入れ条件を明確に
2. 既存のテストファイルを参照させる
   - 「`login.spec.ts` を参考にしてください」等
3. 境界線（Boundaries）を確認
   - エージェントが従うべきルールを追加

### Q3. 生成されたテストが実行できない

**確認事項:**
```bash
# 1. Playwright が正しくインストールされているか
npx playwright --version

# 2. ブラウザがインストールされているか
npx playwright install

# 3. アプリケーションが起動しているか
curl http://localhost:5173
```

### Q4. エージェントの応答が遅い

**理由:**
- GitHub のサーバー負荷
- エージェントが複雑な実装を行っている

**対処法:**
- 待つ（通常 1-3 分程度）
- Issue を小さく分割する

---

## ✅ エージェント利用のベストプラクティス

### Issue 作成時

1. **明確なタイトル**
   ```
   ✅ 良い例: "ログイン機能のE2Eテスト作成"
   ❌ 悪い例: "テスト追加"
   ```

2. **詳細な背景説明**
   ```markdown
   ## 背景
   ログイン機能の品質保証のため、E2Eテストを追加する必要があります。
   現在、手動テストのみで回帰テストに時間がかかっています。
   ```

3. **具体的なテストシナリオ**
   ```markdown
   ## テストシナリオ
   - [ ] 正常系: 正しい認証情報でログイン成功
   - [ ] 異常系: 空のユーザ名でエラー表示
   - [ ] 異常系: 不正なパスワードでエラー表示
   ```

4. **受け入れ条件の明確化**
   ```markdown
   ## 受け入れ条件
   - すべてのテストがローカルで成功すること
   - Allureレポートが生成されること
   - テストカバレッジが80%以上であること
   ```

### エージェント利用後

1. **コードレビュー**
   - 生成されたテストが要件を満たしているか確認
   - セレクタが適切か確認（アクセシビリティベース）
   - 待機処理が適切か確認

2. **ローカルでの実行確認**
   ```bash
   cd frontend
   npm test:e2e
   ```

3. **レポート確認**
   ```bash
   npm run test:e2e:report
   ```

4. **必要に応じて修正**
   - エージェントが生成したコードを修正してもOK
   - 修正内容をコミットメッセージに記載

---

## 📚 関連ドキュメント

- [GitHub Copilot カスタムコマンド vs カスタムエージェント比較](./12-カスタムコマンドVSカスタムエージェント比較.md)
- [E2E テスト自動生成ガイド（カスタムコマンド）](./13-E2Eテスト自動生成ガイド.md)
- [テスト戦略](./08-テスト戦略.md)
- [README - E2E テスト実行](../README.md#-e2e-テスト実行)

---

## 🎯 まとめ

| 観点 | 説明 |
|------|------|
| **エージェント名** | `e2e-test-specialist` |
| **実行方法** | GitHub Issue にアサイン / Copilot Chat で `@e2e-test-specialist` |
| **生成ファイル** | `frontend/tests/e2e/[feature].spec.ts` |
| **自動PR作成** | ✅ 可能（Issue 経由の場合） |
| **並列実行** | ✅ 可能（複数 Issue 同時アサイン） |
| **デバッグ方法** | `npx playwright test --headed` |

このカスタムエージェントを使用することで、GitHub Issue から直接 E2E テストの自動実装が可能になり、開発効率が大幅に向上します。

---

**作成日**: 2026年1月  
**最終更新**: 2026年1月
